# 6 — Agent: tools, prompts & tool calling

Design the agent as an LLM orchestrator that can call predefined tools. Tools are thin wrappers over the real APIs; they should be deterministic and idempotent when possible.

#### Example tool set

- `search_contacts(query)` → search HubSpot contacts + RAG search on documents
- `get_contact(contact_id_or_name)` → return contact details
- `create_contact({email, name, metadata})`
- `add_contact_note(contact_id, note)`
- `send_email({to, subject, body, threadId?})`
- `propose_meeting_times(userId, availability_window, duration)` → consult Google Calendar freebusy and return options
- `create_calendar_event({attendees, start, end, description})`
- `update_task(task_id, status, result)`
- `query_calendar(range) → list events`
- `search_documents(query, k)`

#### Tool calling design

- Use an LLM that supports tool calls (or emulate with structured JSON output validated by the backend).
- When the model returns a tool call, the backend executes the tool, records outputs (in tasks or documents) and then returns tool results back to the LLM to continue the chain.
- For long-running interactions (waiting for an email reply), create a task in DB and a durable workflow (Temporal/BullMQ) to:
  - wait for webhook that matches threadId/from address
  - resume the workflow, call the LLM with new context, perform follow-up actions 
  
#### Example flow: “Schedule an appointment with Sara Smith”

1. User: "Schedule an appointment with Sara Smith."
2. LLM: calls search_contacts("Sara Smith") — returns HubSpot contact (email).
3. LLM: calls propose_meeting_times(userId, 3 days, 30m) → backend checks calendar freebusy and returns 3 slots.
4. LLM: decides to email Sara with available times and send as a meeting request or propose times. Calls send_email({to: sara@example.com, subject, body}). Save threadId and create task with status waiting_for_response.
5. When webhook receives reply on same thread, the workflow resumes: parse reply, LLM decides next action (create event, ask for more times), call create_calendar_event and add_contact_note, update HubSpot and mark task completed. Each step logged.

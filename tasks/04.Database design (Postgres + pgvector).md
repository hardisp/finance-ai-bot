# 4 â€” Database design (Postgres + pgvector)

Use Postgres with pgvector extension to store embeddings and retrieval metadata.

Key tables (simplified)

```sql
-- users
CREATE TABLE users (
  id uuid PRIMARY KEY,
  email text UNIQUE NOT NULL,
  google_id text,
  hubspot_account_id text,
  created_at timestamptz DEFAULT now()
);

-- oauth_tokens
CREATE TABLE oauth_tokens (
  id serial PRIMARY KEY,
  user_id uuid REFERENCES users(id),
  provider text NOT NULL, -- 'google' or 'hubspot'
  access_token text,
  refresh_token text,
  scope text,
  expires_at timestamptz,
  created_at timestamptz DEFAULT now()
);

-- documents (emails, notes, transcripts)
CREATE TABLE documents (
  id uuid PRIMARY KEY,
  user_id uuid REFERENCES users(id),
  source text, -- 'gmail' or 'hubspot'
  source_id text, -- messageId or hubspot note id
  subject text,
  snippet text,
  content text, -- full text
  metadata jsonb,
  created_at timestamptz DEFAULT now()
);

-- vectors (pgvector)
CREATE TABLE vectors (
  id serial PRIMARY KEY,
  document_id uuid REFERENCES documents(id),
  embedding VECTOR(1536), -- depends on embedding dim
  chunk_index int,
  created_at timestamptz DEFAULT now()
);

-- tasks (queued/ongoing tasks created by agent)
CREATE TABLE tasks (
  id uuid PRIMARY KEY,
  user_id uuid REFERENCES users(id),
  type text, -- 'schedule_meeting', 'send_email', ...
  payload jsonb,
  status text, -- 'pending', 'in_progress', 'waiting_for_response', 'completed', 'failed'
  last_updated timestamptz DEFAULT now(),
  created_at timestamptz DEFAULT now()
);

-- memory/instructions (ongoing instructions)
CREATE TABLE memories (
  id serial PRIMARY KEY,
  user_id uuid REFERENCES users(id),
  type text, -- 'rule' or 'short-term' etc
  text text,
  metadata jsonb,
  created_at timestamptz DEFAULT now()
);
```
